# Copyright 2024 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- name: Set fact for email alerting inputs
  when: alert_email_address | length > 1
  block:
    - name: Set alert_email_list
      ansible.builtin.set_fact:
        alert_email_list: "{{ alert_email_address.split(',') }}"

- name: Warning - alert_email_address is empty
  ansible.builtin.debug:
    msg: "{{ alert_email_warning_msg }}"
  when: alert_email_address | length < 1

- name: Prepare user list
  ansible.builtin.set_fact:
    user_list: "{{ lookup('vars', 'user').split() | unique | select | list }}"
  when: user | length > 1

- name: Set allow_deny, restrict_program_support value
  ansible.builtin.set_fact:
    allow_deny: "{{ allow_deny | lower }}"
    restrict_program_support: "{{ restrict_program_support | lower }}"

- name: Pause for 15 seconds after warning
  ansible.builtin.pause:
    seconds: "{{ warning_wait_time_warning }}"
    prompt: "{{ root_user_absence }}"
  when:
    - "user_list is defined and user_list | length > 1"
    - "'root' not in user_list"
    - "allow_deny == 'allow'"

- name: Initialize variables for restrict_softwares
  ansible.builtin.set_fact:
    restrict_program_status: false
    disable_services: []

- name: Validate Restrict program support variables
  when: restrict_program_support
  block:
    - name: The services needs to be disabled are appending to list
      ansible.builtin.set_fact:
        services_list: "{{ lookup('vars', 'restrict_softwares').split(',') | map('trim') | unique | select | list }}"

    - name: Creating a list for disabling services
      ansible.builtin.set_fact:
        disable_services: "{{ disable_services + [item | lower] }}"
      when:
        - item | lower == 'telnet' or
          item | lower == 'lpd' or
          item | lower == 'bluetooth' or
          item | lower == 'rlogin' or
          item | lower == 'rexec'
      with_items: "{{ services_list }}"

    - name: Setting restrict_program_status
      ansible.builtin.set_fact:
        restrict_program_status: true
      when:
        - disable_services | length > 0
